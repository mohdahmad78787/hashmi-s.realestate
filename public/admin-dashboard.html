<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Real Estate Platform</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #dc3545;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
      }

      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .sidebar {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        min-height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        z-index: 1000;
      }

      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 15px 20px;
        border-radius: 0;
        transition: all 0.3s ease;
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .main-content {
        margin-left: 250px;
        padding: 20px;
      }

      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .stats-card {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
      }

      .avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
      }

      .btn-gradient {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
      }

      .btn-gradient:hover {
        background: linear-gradient(135deg, #fd7e14 0%, #dc3545 100%);
        color: white;
      }

      .user-row.blacklisted {
        background-color: #ffe6e6;
        border-left: 4px solid #dc3545;
      }

      .badge-blacklisted {
        background-color: #dc3545 !important;
      }

      .modal-content {
        border-radius: 15px;
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          position: relative;
          min-height: auto;
        }

        .main-content {
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="text-center py-4">
        <div class="avatar mb-3">
          <span id="user-avatar">A</span>
        </div>
        <h5 class="text-white mb-0">
          Welcome, <span id="user-name">Admin</span>
        </h5>
      </div>

      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="showSection('overview')">
            <i class="fas fa-tachometer-alt me-2"></i> Overview
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('manage-sellers')">
            <i class="fas fa-store me-2"></i> Manage Sellers
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            href="#"
            onclick="showSection('manage-customers')"
          >
            <i class="fas fa-users me-2"></i> Manage Customers
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('all-properties')">
            <i class="fas fa-building me-2"></i> All Properties
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('change-password')">
            <i class="fas fa-key me-2"></i> Change Password
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt me-2"></i> Logout
          </a>
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Overview Section -->
      <div id="overview-section" class="content-section">
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card stats-card">
              <div class="card-body text-center">
                <i class="fas fa-store fa-2x mb-3"></i>
                <h3 id="total-sellers">0</h3>
                <p class="mb-0">Total Sellers</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stats-card">
              <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-3"></i>
                <h3 id="total-customers">0</h3>
                <p class="mb-0">Total Customers</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stats-card">
              <div class="card-body text-center">
                <i class="fas fa-building fa-2x mb-3"></i>
                <h3 id="total-properties">0</h3>
                <p class="mb-0">Total Properties</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stats-card">
              <div class="card-body text-center">
                <i class="fas fa-ban fa-2x mb-3"></i>
                <h3 id="blacklisted-users">0</h3>
                <p class="mb-0">Blacklisted Users</p>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>System Status</h5>
              </div>
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <span>Database</span>
                  <span class="badge bg-success" id="db-status">Online</span>
                </div>
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <span>Email Service</span>
                  <span class="badge bg-success" id="email-status">Active</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <span>AI Service</span>
                  <span class="badge bg-warning" id="ai-status">Limited</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5><i class="fas fa-clock me-2"></i>Recent Activities</h5>
              </div>
              <div class="card-body">
                <div id="recent-activities">
                  <p class="text-muted">Loading recent activities...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Manage Sellers Section -->
      <div
        id="manage-sellers-section"
        class="content-section"
        style="display: none"
      >
        <div class="card">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5><i class="fas fa-store me-2"></i>Manage Sellers</h5>
            <button class="btn btn-gradient" onclick="openAddSellerModal()">
              <i class="fas fa-plus me-1"></i> Add New Seller
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Name</th>
                    <th>User ID</th>
                    <th>Email</th>
                    <th>Contact</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="sellers-table">
                  <tr>
                    <td colspan="7" class="text-center">Loading sellers...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Manage Customers Section -->
      <div
        id="manage-customers-section"
        class="content-section"
        style="display: none"
      >
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-users me-2"></i>Manage Customers</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Name</th>
                    <th>User ID</th>
                    <th>Email</th>
                    <th>Contact</th>
                    <th>Verified</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="customers-table">
                  <tr>
                    <td colspan="8" class="text-center">
                      Loading customers...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- All Properties Section -->
      <div
        id="all-properties-section"
        class="content-section"
        style="display: none"
      >
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-building me-2"></i>All Properties</h5>
          </div>
          <div class="card-body">
            <div id="properties-container">
              <p class="text-muted">Loading properties...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Change Password Section -->
      <div
        id="change-password-section"
        class="content-section"
        style="display: none"
      >
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-key me-2"></i>Change Password</h5>
          </div>
          <div class="card-body">
            <form id="change-password-form">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Current Password</label>
                    <input
                      type="password"
                      class="form-control"
                      id="current-password"
                      required
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input
                      type="password"
                      class="form-control"
                      id="new-password"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Confirm New Password</label>
                    <input
                      type="password"
                      class="form-control"
                      id="confirm-password"
                      required
                    />
                  </div>
                </div>
              </div>
              <button type="submit" class="btn btn-gradient">
                <i class="fas fa-save me-1"></i> Change Password
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Seller Modal -->
    <div class="modal fade" id="addSellerModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Seller</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="add-seller-form">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Full Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="seller-name"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">User ID</label>
                <input
                  type="text"
                  class="form-control"
                  id="seller-userId"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="seller-email"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="seller-password"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="seller-address"
                  rows="2"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Contact Details</label>
                <input type="text" class="form-control" id="seller-contact" />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-gradient">
                Create Seller
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit User Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="edit-user-form">
            <div class="modal-body">
              <input type="hidden" id="edit-user-id" />
              <div class="mb-3">
                <label class="form-label">Full Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-name"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">User ID</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-userId"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="edit-email"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >New Password (leave blank to keep current)</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="edit-password"
                />
                <div class="form-text">
                  Only enter a password if you want to change it
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="edit-address"
                  rows="2"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Contact Details</label>
                <input type="text" class="form-control" id="edit-contact" />
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="edit-blacklisted"
                  />
                  <label class="form-check-label" for="edit-blacklisted">
                    Blacklist User
                  </label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-gradient">
                Update User
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Are you sure you want to delete this user? This action cannot be
              undone.
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="confirm-delete-btn"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let users = [];
      let properties = [];
      let userToDelete = null;

      // Load data on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadDashboardData();
      });

      function showSection(sectionName) {
        // Hide all sections
        document.querySelectorAll(".content-section").forEach((section) => {
          section.style.display = "none";
        });

        // Remove active class from all nav links
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });

        // Show selected section
        document.getElementById(sectionName + "-section").style.display =
          "block";

        // Add active class to clicked nav link
        event.target.classList.add("active");

        // Load section-specific data
        switch (sectionName) {
          case "manage-sellers":
          case "manage-customers":
            loadUsers();
            break;
          case "all-properties":
            loadProperties();
            break;
        }
      }

      async function loadDashboardData() {
        try {
          // Load users
          await loadUsers();

          // Load properties
          const propertiesResponse = await fetch("/api/properties");
          if (propertiesResponse.ok) {
            properties = await propertiesResponse.json();
            document.getElementById("total-properties").textContent =
              properties.length;
          }

          // Update stats
          updateStats();
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      async function loadUsers() {
        try {
          const response = await fetch("/api/admin/users");
          if (response.ok) {
            users = await response.json();
            updateStats();
            displayUsers();
          } else {
            console.error("Failed to load users");
          }
        } catch (error) {
          console.error("Error loading users:", error);
        }
      }

      function updateStats() {
        const sellers = users.filter((user) => user.role === "seller");
        const customers = users.filter((user) => user.role === "customer");
        const blacklistedUsers = users.filter((user) => user.isBlacklisted);

        document.getElementById("total-sellers").textContent = sellers.length;
        document.getElementById("total-customers").textContent =
          customers.length;
        document.getElementById("blacklisted-users").textContent =
          blacklistedUsers.length;
      }

      function displayUsers() {
        displaySellers();
        displayCustomers();
      }

      function displaySellers() {
        const sellersTableBody = document.getElementById("sellers-table");
        const sellers = users.filter((user) => user.role === "seller");

        if (sellers.length === 0) {
          sellersTableBody.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">No sellers found</td></tr>';
          return;
        }

        let html = "";
        sellers.forEach((seller) => {
          html += `
                    <tr class="${
                      seller.isBlacklisted ? "user-row blacklisted" : "user-row"
                    }">
                        <td>${seller.name}</td>
                        <td>${seller.userId}</td>
                        <td>${seller.email}</td>
                        <td>${seller.contactDetails || "N/A"}</td>
                        <td>
                            ${
                              seller.isBlacklisted
                                ? '<span class="badge badge-blacklisted">Blacklisted</span>'
                                : '<span class="badge bg-success">Active</span>'
                            }
                        </td>
                        <td>${new Date(
                          seller.createdAt
                        ).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser('${
                              seller._id
                            }')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('${
                              seller._id
                            }')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
        });
        sellersTableBody.innerHTML = html;
      }

      function displayCustomers() {
        const customersTableBody = document.getElementById("customers-table");
        const customers = users.filter((user) => user.role === "customer");

        if (customers.length === 0) {
          customersTableBody.innerHTML =
            '<tr><td colspan="8" class="text-center text-muted">No customers found</td></tr>';
          return;
        }

        let html = "";
        customers.forEach((customer) => {
          html += `
                    <tr class="${
                      customer.isBlacklisted
                        ? "user-row blacklisted"
                        : "user-row"
                    }">
                        <td>${customer.name}</td>
                        <td>${customer.userId}</td>
                        <td>${customer.email}</td>
                        <td>${customer.contactDetails || "N/A"}</td>
                        <td>
                            ${
                              customer.isVerified
                                ? '<span class="badge bg-success">Yes</span>'
                                : '<span class="badge bg-warning">No</span>'
                            }
                        </td>
                        <td>
                            ${
                              customer.isBlacklisted
                                ? '<span class="badge badge-blacklisted">Blacklisted</span>'
                                : '<span class="badge bg-success">Active</span>'
                            }
                        </td>
                        <td>${new Date(
                          customer.createdAt
                        ).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser('${
                              customer._id
                            }')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('${
                              customer._id
                            }')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
        });
        customersTableBody.innerHTML = html;
      }

      async function loadProperties() {
        try {
          const response = await fetch("/api/properties");
          if (response.ok) {
            properties = await response.json();
            displayProperties();
          }
        } catch (error) {
          console.error("Error loading properties:", error);
        }
      }

      function displayProperties() {
        const container = document.getElementById("properties-container");
        if (properties.length === 0) {
          container.innerHTML =
            '<p class="text-muted">No properties found.</p>';
          return;
        }

        let html = '<div class="row">';
        properties.forEach((property) => {
          html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="position-relative">
                                <img src="/${
                                  property.images[0]
                                }" class="card-img-top" style="height: 200px; object-fit: cover;" alt="Property Image">
                                <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" onclick="deleteProperty('${
                                  property._id
                                }')" title="Delete Property">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title">${property.title}</h6>
                                <p class="card-text text-success fw-bold">â‚¹${property.price.toLocaleString()}</p>
                                <p class="card-text">${property.description.substring(
                                  0,
                                  100
                                )}...</p>
                                <p class="card-text"><small class="text-muted">${
                                  property.physicalAddress
                                }</small></p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">By: ${
                                      property.sellerId.name
                                    }</small>
                                    <div>
                                        <span class="badge bg-primary me-1">${
                                          property.questions.length
                                        } Q&A</span>
                                        <span class="badge bg-success">${
                                          property.interestedBuyers.length
                                        } Interested</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        });
        html += "</div>";
        container.innerHTML = html;
      }

      function openAddSellerModal() {
        document.getElementById("add-seller-form").reset();
        new bootstrap.Modal(document.getElementById("addSellerModal")).show();
      }

      function editUser(userId) {
        const user = users.find((u) => u._id === userId);
        if (!user) return;

        document.getElementById("edit-user-id").value = user._id;
        document.getElementById("edit-name").value = user.name;
        document.getElementById("edit-userId").value = user.userId;
        document.getElementById("edit-email").value = user.email;
        document.getElementById("edit-password").value = "";
        document.getElementById("edit-address").value = user.address || "";
        document.getElementById("edit-contact").value =
          user.contactDetails || "";
        document.getElementById("edit-blacklisted").checked =
          user.isBlacklisted || false;

        new bootstrap.Modal(document.getElementById("editUserModal")).show();
      }

      function confirmDelete(userId) {
        userToDelete = userId;
        new bootstrap.Modal(document.getElementById("deleteModal")).show();
      }

      async function deleteProperty(propertyId) {
        if (
          confirm(
            "Are you sure you want to delete this property? This action cannot be undone."
          )
        ) {
          try {
            const response = await fetch(`/api/properties/${propertyId}`, {
              method: "DELETE",
            });

            if (response.ok) {
              alert("Property deleted successfully!");
              loadProperties();
              loadDashboardData(); // Refresh stats
            } else {
              const error = await response.json();
              alert("Error: " + error.error);
            }
          } catch (error) {
            console.error("Error deleting property:", error);
            alert("Error deleting property. Please try again.");
          }
        }
      }

      // Add Seller Form Submission
      document
        .getElementById("add-seller-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          try {
            const response = await fetch("/api/admin/create-seller", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: document.getElementById("seller-name").value,
                userId: document.getElementById("seller-userId").value,
                email: document.getElementById("seller-email").value,
                password: document.getElementById("seller-password").value,
                address: document.getElementById("seller-address").value,
                contactDetails: document.getElementById("seller-contact").value,
              }),
            });

            if (response.ok) {
              alert("Seller created successfully!");
              bootstrap.Modal.getInstance(
                document.getElementById("addSellerModal")
              ).hide();
              loadUsers();
            } else {
              const error = await response.json();
              alert("Error: " + error.error);
            }
          } catch (error) {
            console.error("Error creating seller:", error);
            alert("Error creating seller. Please try again.");
          }
        });

      // Edit User Form Submission
      document
        .getElementById("edit-user-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const userId = document.getElementById("edit-user-id").value;

          try {
            const response = await fetch(`/api/admin/users/${userId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: document.getElementById("edit-name").value,
                userId: document.getElementById("edit-userId").value,
                email: document.getElementById("edit-email").value,
                password: document.getElementById("edit-password").value,
                address: document.getElementById("edit-address").value,
                contactDetails: document.getElementById("edit-contact").value,
                isBlacklisted:
                  document.getElementById("edit-blacklisted").checked,
              }),
            });

            if (response.ok) {
              alert("User updated successfully!");
              bootstrap.Modal.getInstance(
                document.getElementById("editUserModal")
              ).hide();
              loadUsers();
            } else {
              const error = await response.json();
              alert("Error: " + error.error);
            }
          } catch (error) {
            console.error("Error updating user:", error);
            alert("Error updating user. Please try again.");
          }
        });

      // Delete User Confirmation
      document
        .getElementById("confirm-delete-btn")
        .addEventListener("click", async function () {
          if (!userToDelete) return;

          try {
            const response = await fetch(`/api/admin/users/${userToDelete}`, {
              method: "DELETE",
            });

            if (response.ok) {
              alert("User deleted successfully!");
              bootstrap.Modal.getInstance(
                document.getElementById("deleteModal")
              ).hide();
              loadUsers();
              loadDashboardData(); // Refresh stats
            } else {
              const error = await response.json();
              alert("Error: " + error.error);
            }
          } catch (error) {
            console.error("Error deleting user:", error);
            alert("Error deleting user. Please try again.");
          }

          userToDelete = null;
        });

      // Change Password Form Submission
      document
        .getElementById("change-password-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          if (newPassword !== confirmPassword) {
            alert("New passwords do not match!");
            return;
          }

          try {
            const response = await fetch("/api/admin/change-password", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                currentPassword:
                  document.getElementById("current-password").value,
                newPassword: newPassword,
              }),
            });

            if (response.ok) {
              alert("Password changed successfully!");
              document.getElementById("change-password-form").reset();
            } else {
              const error = await response.json();
              alert("Error: " + error.error);
            }
          } catch (error) {
            console.error("Error changing password:", error);
            alert("Error changing password. Please try again.");
          }
        });

      async function logout() {
        try {
          await fetch("/api/logout", { method: "POST" });
          window.location.href = "/login";
        } catch (error) {
          console.error("Logout error:", error);
          window.location.href = "/login";
        }
      }
    </script>
  </body>
</html>
